# Exercise 7.17
class Sum:

    def __init__(self, f_k, M, N):
        self.f_k = f_k
        self.M = M
        self.N = N
        self.first_neglected_term = None

    def __call__(self, x):
        S = 0
        f_k, M, N = self.f_k, self.M, self.N
        for k in xrange(M, N + 1):
            S += f_k(x, k)
        # calcuate and store next term in the series
        self.first_neglected_term = f_k(x, N + 1)
        return S


def table(term, x, M, Nlist, f):
    print '=' * 58
    print '%-14s %-14s %-14s %-14s' \
        % ('x=%g' % x, "f (approx.)", 'Error', 'Next term')
    print '-' * 58
    for N in Nlist:
        S = Sum(term, M, N)
        print 'N = %-8d | %13.6E  %13.6E  %13E' \
            % (N, S(x), f(x) - S(x), S.first_neglected_term)
    print '=' * 58 + '\n'


def factorial(n):
    if n == 0:
        return 1
    else:
        return n * factorial(n - 1)


def term(x, k):  # Taylor series approximation of 1/(1+x)
    return (-x) ** k
S = Sum(term, M=0, N=100)
x = 0.5
print S(x)
print S.first_neglected_term


from math import sin, pi, exp, log


def term(x, k):  # Taylor series approximation of sin(x)
    return (-1) ** k * x ** (2 * k + 1) / float(factorial(2 * k + 1))
print '\nf(x) = sin(x)'
for x in (pi, 30 * pi):
    table(term, x, M=0, Nlist=(5, 10, 20), f=sin)


def term(x, k):  # Taylor series approximation of exp(x)
    return ((-x) ** k) / float(factorial(k))
print '\nf(x) = exp(-x)'
for x in (1, 3, 5):
    table(term, x, M=0, Nlist=(5, 10, 20), f=lambda x: exp(-x))


def term(x, k):  # Taylor series approximation of ln(1 + x)
    return (1 / float(k)) * (x / float(1 + x)) ** k
print '\nf(x) = ln(1 + x)'
for x in (2, 5, 10):
    table(term, x, M=1, Nlist=(5, 10, 20), f=log)

"""
Sample run:
python Sum.py
0.666666666667
-3.94430452611e-31

f(x) = sin(x)
==========================================================
x=3.14159      f (approx.)    Error          Next term
----------------------------------------------------------
N = 5        | -4.451602E-04   4.451602E-04   4.663028E-04
N = 10       |  1.034819E-11  -1.034806E-11  -1.051847E-11
N = 20       |  3.328057E-16  -2.103410E-16  -3.947279E-32
==========================================================

==========================================================
x=94.2478      f (approx.)    Error          Next term
----------------------------------------------------------
N = 5        | -1.289611E+14   1.289611E+14   7.434373E+15
N = 10       |  5.384159E+21  -5.384159E+21  -9.902424E+22
N = 20       |  2.218476E+31  -2.218476E+31  -1.295722E+32
==========================================================


f(x) = exp(-x)
==========================================================
x=1            f (approx.)    Error          Next term
----------------------------------------------------------
N = 5        |  3.666667E-01   1.212775E-03   1.388889E-03
N = 10       |  3.678795E-01  -2.311427E-08  -2.505211E-08
N = 20       |  3.678794E-01  -1.110223E-16  -1.957294E-20
==========================================================

==========================================================
x=3            f (approx.)    Error          Next term
----------------------------------------------------------
N = 5        | -6.500000E-01   6.997871E-01   1.012500E+00
N = 10       |  5.332589E-02  -3.538824E-03  -4.437906E-03
N = 20       |  4.978707E-02  -1.800562E-10  -2.047399E-10
==========================================================

==========================================================
x=5            f (approx.)    Error          Next term
----------------------------------------------------------
N = 5        | -1.233333E+01   1.234007E+01   2.170139E+01
N = 10       |  8.640391E-01  -8.573011E-01  -1.223247E+00
N = 20       |  6.745540E-03  -7.593099E-06  -9.333106E-06
==========================================================


f(x) = ln(1 + x)
==========================================================
x=2            f (approx.)    Error          Next term
----------------------------------------------------------
N = 5        |  1.063374E+00  -3.702273E-01   1.463192E-02
N = 10       |  1.095869E+00  -4.027220E-01   1.051002E-03
N = 20       |  1.098586E+00  -4.054387E-01   9.546942E-06
==========================================================

==========================================================
x=5            f (approx.)    Error          Next term
----------------------------------------------------------
N = 5        |  1.574396E+00   3.504234E-02   5.581633E-02
N = 10       |  1.736836E+00  -1.273984E-01   1.223527E-02
N = 20       |  1.786568E+00  -1.771302E-01   1.035081E-03
==========================================================

==========================================================
x=10           f (approx.)    Error          Next term
----------------------------------------------------------
N = 5        |  1.867690E+00   4.348951E-01   9.407899E-02
N = 10       |  2.179067E+00   1.235181E-01   3.186308E-02
N = 20       |  2.345803E+00  -4.321799E-02   6.434789E-03
==========================================================
"""
